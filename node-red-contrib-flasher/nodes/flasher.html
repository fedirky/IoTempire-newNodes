<!-- flasher.html -->

<style>
/* Make dialog fields look like the main editor fields */

/* Row spacing & layout */
#flasher-sensor-dialog .form-row {
  display: flex;               /* align label + field like the main form */
  align-items: center;
  gap: 8px;                    /* space between label and field */
  margin-bottom: 8px;          /* vertical space between rows */
}

/* Label width similar to the main editor */
#flasher-sensor-dialog .form-row > label {
  width: 160px;                /* tweak if your editor uses a different width */
  display: inline-block;
  margin: 0;                   /* remove extra spacing */
  white-space: nowrap;
  color: #555;                 /* softer text color */
}

/* Inputs/selects look & sizing */
#flasher-sensor-dialog .form-row > input[type="text"],
#flasher-sensor-dialog .form-row > select {
  flex: 1;                     /* take remaining width */
  height: 28px;                /* match Node-RED default control height */
  line-height: 1.4;
  padding: 2px 6px;
  box-sizing: border-box;
  border: 1px solid var(--red-ui-secondary-border, #c8c8c8); /* softer border */
  border-radius: 4px;
  background: #fff;
  font-size: 13px;
  color: #444;
}

/* Focus state similar to editor (no harsh black outline) */
#flasher-sensor-dialog .form-row > input[type="text"]:focus,
#flasher-sensor-dialog .form-row > select:focus {
  outline: none;
  border-color: #9ecaed;
  box-shadow: 0 0 0 2px rgba(158,202,237,.2);
}

/* Make sure dialog body blends with editor */
.ui-dialog .ui-dialog-content#flasher-sensor-dialog {
  padding-top: 10px;           /* extra breathing room above rows */
  background: #fff;
}

/* Button bar spacing consistent with editor */
.ui-dialog .ui-dialog-buttonpane {
  padding: 0.4em 0.6em 0.6em;
}
</style>

<!-- Config node template for folder settings -->
<script type="text/html" data-template-name="flasher-folder">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Optional">
  </div>
  <div class="form-row">
    <label for="node-config-input-path"><i class="fa fa-folder-open"></i> Folder</label>
    <input type="text" id="node-config-input-path" placeholder="~/iot-systems/demo">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiSSID"><i class="fa fa-wifi"></i> WiFi SSID</label>
    <input type="text" id="node-config-input-wifiSSID" placeholder="Your WiFi SSID">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiPassword"><i class="fa fa-lock"></i> WiFi Password</label>
    <input type="password" id="node-config-input-wifiPassword" placeholder="Your WiFi Password">
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType("flasher-folder", {
  category: "config",
  defaults: {
    name:     { value: "" },
    path:     { value: "~/iot-systems/demo", required: false },
    wifiSSID: { value: "", required: false }
  },
  credentials: {
    wifiPassword: { type: "password" }
  },
  label: function () {
    return this.name || this.path || "folder";
  }
});
</script>

<!-- Main node template -->
<script type="text/html" data-template-name="flasher">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Label (optional)">
  </div>

  <div class="form-row">
    <div class="red-ui-tabs">
      <div>
        <ul id="node-config-flasher-tabs" style="margin-bottom:10px;">
          <li class="red-ui-tab active" id="red-ui-tab-flasher-folder" style="width:50%;">
            <a href="#flasher-tab-folder" class="red-ui-tab-label">Flashing Info</a>
          </li>
          <li class="red-ui-tab" id="red-ui-tab-flasher-sensor" style="width:50%;">
            <a href="#flasher-tab-sensor" class="red-ui-tab-label">Controller & Sensors</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div id="node-config-flasher-tabs-content" style="min-height:100px;">
    <!-- Flashing tab -->
    <div id="flasher-tab-folder" style="display:block;">
      <div class="form-row">
        <label for="node-input-folder"><i class="fa fa-folder-open"></i> Folder Config</label>
        <input type="text" id="node-input-folder">
      </div>
      <div class="form-row">
        <label for="node-input-nodeName"><i class="fa fa-cube"></i> Node</label>
        <input type="text" id="node-input-nodeName" placeholder="test01">
      </div>
      <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Serial Port</label>
        <input type="text" id="node-input-port" placeholder="/dev/ttyUSB0">
      </div>
    </div>

    <!-- Controller & Sensors tab -->
    <div id="flasher-tab-sensor" style="display:none;">
      <div class="form-row">
        <label for="node-input-controllerType"><i class="fa fa-microchip"></i> Controller Type</label>
        <select id="node-input-controllerType">
          <option value="Wemos D1 Mini">Wemos D1 Mini</option>
          <option value="m5stickc">M5StickC</option>
        </select>
      </div>

      <!-- Sensor 1 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 1</label>
        <button id="btn-s1" class="red-ui-button">Sensor 1 Settings…</button>
      </div>

      <!-- Sensor 2 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 2</label>
        <button id="btn-s2" class="red-ui-button">Sensor 2 Settings…</button>
      </div>

      <!-- Sensor 3 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 3</label>
        <button id="btn-s3" class="red-ui-button">Sensor 3 Settings…</button>
      </div>

      <!-- Hidden fields actually saved by Node-RED -->
      <input type="text" id="node-input-sensor1" style="display:none">
      <input type="text" id="node-input-sensor2" style="display:none">
      <input type="text" id="node-input-sensor3" style="display:none">
      <input type="text" id="node-input-mqttChannel1" style="display:none">
      <input type="text" id="node-input-mqttChannel2" style="display:none">
      <input type="text" id="node-input-mqttChannel3" style="display:none">
    </div>
  </div>

  <!-- Reusable dialog for Sensor Settings -->
  <div id="flasher-sensor-dialog" style="display:none;">
    <div class="form-row">
      <label for="dlg-sensor-type"><i class="fa fa-thermometer-half"></i> Sensor</label>
      <select id="dlg-sensor-type">
        <option value="">— None —</option>
        <option value="dht">Temperature/Humidity (DHT)</option>
        <option value="mfrc522">Tag Reader (MFRC522)</option>
        <option value="hcsr04">Ultrasonic Distance (HCSR04)</option>
      </select>
    </div>
    <div class="form-row">
      <label for="dlg-sensor-topic"><i class="fa fa-share-alt"></i> MQTT Channel</label>
      <input type="text" id="dlg-sensor-topic" placeholder="topic/name">
    </div>
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType('flasher', {
  category: 'network',
  color: '#d65a31',
  icon: 'fa-microchip',
  inputs: 1,
  outputs: 1,
  defaults: {
    name:            { value: "" },
    controllerType:  { value: "Wemos D1 Mini" },

    // Three sensors stored separately
    sensor1:         { value: "" },
    sensor2:         { value: "" },
    sensor3:         { value: "" },

    // Separate MQTT channels
    mqttChannel1:    { value: "" },
    mqttChannel2:    { value: "" },
    mqttChannel3:    { value: "" },

    folder:          { type: "flasher-folder", required: true },
    nodeName:        { value: "test01" },
    port:            { value: "/dev/ttyUSB0" }
  },
  label: function() {
    var s = [this.sensor1, this.sensor2, this.sensor3].filter(Boolean);
    var sensors = s.length ? s.join('+') : 'no-sensor';
    return this.name || `flasher ${this.controllerType} ${sensors} ${this.nodeName}`;
  },
  oneditprepare: function() {
    var currentIdx = null;

    // Helper: update button text for a given sensor
    function updateButtonLabel(idx) {
      var s = $("#node-input-sensor" + idx).val() || "";
      var t = $("#node-input-mqttChannel" + idx).val() || "";
      var label = "Sensor " + idx + " Settings";
      if (s) {
        label = s + (t ? " → " + t : "");
      }
      $("#btn-s" + idx).text(label);
    }

    // Populate base fields
    $("#node-input-name").val(this.name);
    $("#node-input-nodeName").val(this.nodeName);
    $("#node-input-port").val(this.port);
    $("#node-input-controllerType").val(this.controllerType);

    // Populate hidden sensor/channel fields
    $("#node-input-sensor1").val(this.sensor1 || "");
    $("#node-input-sensor2").val(this.sensor2 || "");
    $("#node-input-sensor3").val(this.sensor3 || "");
    $("#node-input-mqttChannel1").val(this.mqttChannel1 || "");
    $("#node-input-mqttChannel2").val(this.mqttChannel2 || "");
    $("#node-input-mqttChannel3").val(this.mqttChannel3 || "");

    // Initial button labels
    [1, 2, 3].forEach(updateButtonLabel);

    // Tabs switching
    $("#node-config-flasher-tabs li").on('click', function() {
      var id = $(this).attr('id');
      $("#node-config-flasher-tabs li").removeClass('active');
      $(this).addClass('active');
      $("#node-config-flasher-tabs-content > div").hide();
      if (id === 'red-ui-tab-flasher-folder') {
        $('#flasher-tab-folder').show();
      } else {
        $('#flasher-tab-sensor').show();
      }
    });

    // Open dialog for sensor settings
    function openSensorDialog(idx) {
      currentIdx = idx;

      $("#dlg-sensor-type").val($("#node-input-sensor" + idx).val() || "");
      $("#dlg-sensor-topic").val($("#node-input-mqttChannel" + idx).val() || "");

      $("#flasher-sensor-dialog").dialog({
        modal: true,
        width: 520,
        title: "Sensor " + idx + " Settings",
        buttons: [
          {
            text: "Save",
            click: function () {
              $("#node-input-sensor" + currentIdx).val($("#dlg-sensor-type").val()).change();
              $("#node-input-mqttChannel" + currentIdx).val($("#dlg-sensor-topic").val()).change();
              updateButtonLabel(currentIdx);
              updateNodeLabel();
              $(this).dialog("close");
            }
          },
          {
            text: "Cancel",
            click: function () { $(this).dialog("close"); }
          }
        ]
      });
    }

    // Bind open buttons
    $("#btn-s1").on("click", function () { openSensorDialog(1); });
    $("#btn-s2").on("click", function () { openSensorDialog(2); });
    $("#btn-s3").on("click", function () { openSensorDialog(3); });

    // Update node label preview
    function updateNodeLabel() {
      var n = {
        name: $("#node-input-name").val(),
        nodeName: $("#node-input-nodeName").val(),
        controllerType: $("#node-input-controllerType").val()
      };
      var s = [
        $("#node-input-sensor1").val(),
        $("#node-input-sensor2").val(),
        $("#node-input-sensor3").val()
      ].filter(Boolean);
      $(".node-input-label").text(
        RED._(n.name || `flasher ${n.controllerType} ${s.length ? s.join('+') : 'no-sensor'} ${n.nodeName}`)
      );
    }

    // Keep label in sync with field changes
    [
      "#node-input-name",
      "#node-input-nodeName",
      "#node-input-controllerType",
      "#node-input-port",
      "#node-input-folder",
      "#node-input-sensor1",
      "#node-input-sensor2",
      "#node-input-sensor3",
      "#node-input-mqttChannel1",
      "#node-input-mqttChannel2",
      "#node-input-mqttChannel3"
    ].forEach(function(sel){
      $(sel).on('change keyup', updateNodeLabel);
    });

    updateNodeLabel();
  }
});
</script>
