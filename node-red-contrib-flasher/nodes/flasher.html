<!-- flasher.html -->

<!-- External resources (added via package.json -> node-red.resources) -->
<link rel="stylesheet" href="resources/node-red-contrib-flasher/editor/flasher.css">
<script src="resources/node-red-contrib-flasher/editor/flasher.utils.js"></script>
<script src="resources/node-red-contrib-flasher/editor/flasher.pins.js"></script>
<script src="resources/node-red-contrib-flasher/editor/flasher.sensors.js"></script>
<script src="resources/node-red-contrib-flasher/editor/flasher.filters.js"></script>
<script src="resources/node-red-contrib-flasher/editor/flasher.nodes.js"></script>

<!-- Config node template for folder settings -->
<script type="text/html" data-template-name="flasher-folder">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Optional">
  </div>
  <div class="form-row">
    <label for="node-config-input-path"><i class="fa fa-folder-open"></i> Folder</label>
    <input type="text" id="node-config-input-path" placeholder="~/iot-systems/demo">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiSSID"><i class="fa fa-wifi"></i> WiFi SSID</label>
    <input type="text" id="node-config-input-wifiSSID" placeholder="Your WiFi SSID">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiPassword"><i class="fa fa-lock"></i> WiFi Password</label>
    <input type="password" id="node-config-input-wifiPassword" placeholder="Your WiFi Password">
  </div>
  <div class="form-row">
    <label for="node-config-input-mqttHost"><i class="fa fa-server"></i> MQTT Host</label>
    <input type="text" id="node-config-input-mqttHost" placeholder="192.168.14.1">
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType("flasher-folder", {
  category: "config",
  defaults: {
    name:         { value: "" },
    path:         { value: "~/iot-systems/demo", required: false },
    wifiSSID:     { value: "", required: false },
    wifiPassword: { value: "", required: false },   // <-- тепер це звичайне поле
    mqttHost:     { value: "192.168.14.1", required: false } 
  },
  label: function () {
    return this.name || this.path || "folder";
  }
});
</script>

<!-- NEW: Config node: flasher-node (вибір/створення підпапки node) -->
<script type="text/html" data-template-name="flasher-node">
<div class="form-row">
  <label for="node-input-nodeName"><i class="fa fa-cube"></i> Node</label>
  <div style="width:70%; display:inline-flex;">
    <select id="node-input-nodeName" style="flex-grow:1;">
      <!-- опції підвантажуються з JS -->
    </select>
    <a id="flasher-node-rename" class="red-ui-button" style="margin-left:10px;" title="Rename node on disk">
      <i class="fa fa-pencil"></i>
    </a>
    <a id="flasher-node-add" class="red-ui-button" style="margin-left:10px;" title="Create new node folder">
      <i class="fa fa-plus"></i>
    </a>
  </div>
</div>
</script>

<script type="text/javascript">
RED.nodes.registerType("flasher-node", {
  category: "config",
  defaults: {
    name:     { value: "" },
    folder:   { type: "flasher-folder", required: true },
    nodeName: { value: "test01", required: true }
  },
  label: function () {
    return this.name || this.nodeName || "node";
  },
  oneditprepare: function () {
    if (window.flasherNodeEditorInit) window.flasherNodeEditorInit();
  }
});
</script>

<!-- Main node template -->
<script type="text/html" data-template-name="flasher">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Label (optional)">
  </div>

  <div class="form-row">
    <div class="red-ui-tabs">
      <div>
        <ul id="node-config-flasher-tabs" style="margin-bottom:10px;">
          <li class="red-ui-tab active" id="red-ui-tab-flasher-folder" style="width:50%;">
            <a href="#flasher-tab-folder" class="red-ui-tab-label">Flashing Info</a>
          </li>
          <li class="red-ui-tab" id="red-ui-tab-flasher-sensor" style="width:50%;">
            <a href="#flasher-tab-sensor" class="red-ui-tab-label">Controller & Sensors</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div id="node-config-flasher-tabs-content" style="min-height:100px;">
    <!-- Flashing tab -->
    <div id="flasher-tab-folder" style="display:block;">
      <div class="form-row">
        <label for="node-input-folder"><i class="fa fa-folder-open"></i> Folder Config</label>
        <input type="text" id="node-input-folder">
      </div>

      <!-- ЗМІНЕНО: Node тепер select + кнопки, без config-node picker -->
      <div class="form-row">
        <label for="node-input-nodeName"><i class="fa fa-cube"></i> Node</label>
        <div style="display:flex; gap:4px; width:100%;">
          <select id="node-input-nodeName" style="flex:1;">
            <!-- опції підвантажуються з JS -->
          </select>
          <button id="flasher-node-rename" class="red-ui-button" type="button" title="Rename node on disk">
            <i class="fa fa-pencil"></i>
          </button>
          <button id="flasher-node-add" class="red-ui-button" type="button" title="Create new node folder">
            <i class="fa fa-plus"></i>
          </button>
        </div>
      </div>

      <!-- NEW: Deploy method -->
      <div class="form-row">
        <label for="node-input-deployMethod"><i class="fa fa-exchange"></i> Deploy via</label>
        <select id="node-input-deployMethod" style="width:70%;">
          <option value="usb">USB (local /dev/ttyUSBx)</option>
          <option value="mango">Mango (RFC2217 over network)</option>
        </select>
      </div>

      <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Serial Port</label>
        <input type="text" id="node-input-port" placeholder="/dev/ttyUSB0">
      </div>
    </div>

    <!-- Controller & Sensors tab -->
    <div id="flasher-tab-sensor" style="display:none;">
      <div class="form-row">
        <label for="node-input-controllerType"><i class="fa fa-microchip"></i> Controller Type</label>
        <select id="node-input-controllerType">
          <option value="Wemos D1 Mini">Wemos D1 Mini</option>
          <option value="m5stickc_plus">M5Stick CPlus</option>
          <option value="m5stickc_plus2">M5Stick CPlus2</option>
        </select>
      </div>

      <!-- Sensor 1 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 1</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s1"    class="red-ui-button" style="flex:1;">Sensor 1 Settings…</button>
          <button id="btn-s1-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>
      <div class="form-row">
        <label><i class="fa fa-filter"></i> Filter</label>
        <div style="display:flex; gap:8px; width:100%;">
          <select id="node-input-filter1Type" style="flex:1;">
            <option value="">— None —</option>
            <option value="average">Average</option>
            <option value="jmc_median">JMC Running Median</option>
            <option value="jmc_interval_median">JMC Interval Median</option>
            <option value="minchange">Min Change</option>
            <option value="binarize">Binarize</option>
            <option value="round">Round</option>
            <option value="limit_time">Limit per Time</option>
            <option value="detect_click">Click Detector</option>
            <option value="interval_map">Interval Map</option>
          </select>
          <button id="btn-f1-opts" class="red-ui-button" style="width:180px;">Settings…</button>
        </div>
      </div>

      <!-- Sensor 2 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 2</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s2"    class="red-ui-button" style="flex:1;">Sensor 2 Settings…</button>
          <button id="btn-s2-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>
      <div class="form-row">
        <label><i class="fa fa-filter"></i> Filter</label>
        <div style="display:flex; gap:8px; width:100%;">
          <select id="node-input-filter2Type" style="flex:1;">
            <option value="">— None —</option>
            <option value="average">Average</option>
            <option value="jmc_median">JMC Running Median</option>
            <option value="jmc_interval_median">JMC Interval Median</option>
            <option value="minchange">Min Change</option>
            <option value="binarize">Binarize</option>
            <option value="round">Round</option>
            <option value="limit_time">Limit per Time</option>
            <option value="detect_click">Click Detector</option>
            <option value="interval_map">Interval Map</option>
          </select>
          <button id="btn-f2-opts" class="red-ui-button" style="width:180px;">Settings…</button>
        </div>
      </div>

      <!-- Sensor 3 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 3</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s3"    class="red-ui-button" style="flex:1;">Sensor 3 Settings…</button>
          <button id="btn-s3-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>
      <div class="form-row">
        <label><i class="fa fa-filter"></i> Filter</label>
        <div style="display:flex; gap:8px; width:100%;">
          <select id="node-input-filter3Type" style="flex:1;">
            <option value="">— None —</option>
            <option value="average">Average</option>
            <option value="jmc_median">JMC Running Median</option>
            <option value="jmc_interval_median">JMC Interval Median</option>
            <option value="minchange">Min Change</option>
            <option value="binarize">Binarize</option>
            <option value="round">Round</option>
            <option value="limit_time">Limit per Time</option>
            <option value="detect_click">Click Detector</option>
            <option value="interval_map">Interval Map</option>
          </select>
          <button id="btn-f3-opts" class="red-ui-button" style="width:180px;">Settings…</button>
        </div>
      </div>

      <!-- Hidden fields actually saved by Node-RED -->
      <input type="text" id="node-input-sensor1" style="display:none">
      <input type="text" id="node-input-sensor2" style="display:none">
      <input type="text" id="node-input-sensor3" style="display:none">
      <input type="text" id="node-input-mqttChannel1" style="display:none">
      <input type="text" id="node-input-mqttChannel2" style="display:none">
      <input type="text" id="node-input-mqttChannel3" style="display:none">
      <input type="text" id="node-input-sensor1Pins" style="display:none">
      <input type="text" id="node-input-sensor2Pins" style="display:none">
      <input type="text" id="node-input-sensor3Pins" style="display:none">

      <!-- Hidden fields for filter params (JSON) -->
      <input type="text" id="node-input-filter1Params" style="display:none">
      <input type="text" id="node-input-filter2Params" style="display:none">
      <input type="text" id="node-input-filter3Params" style="display:none">
    </div>
  </div>

  <!-- Sensor Settings dialog -->
  <div id="flasher-sensor-dialog" style="display:none;">
    <div class="form-row">
      <label for="dlg-sensor-type"><i class="fa fa-thermometer-half"></i> Sensor</label>
      <select id="dlg-sensor-type"></select>
    </div>
    <div class="form-row">
      <label for="dlg-sensor-topic"><i class="fa fa-share-alt"></i> MQTT Channel</label>
      <input type="text" id="dlg-sensor-topic" placeholder="topic/name">
    </div>
  </div>

  <!-- Pins dialog -->
  <div id="flasher-pins-dialog" style="display:none;">
    <div id="pins-dynamic"></div>
  </div>

  <!-- Filter dialog -->
  <div id="flasher-filter-dialog" style="display:none;">
    <div id="filter-dynamic"></div>
  </div>
</script>

<!-- HELP (help text in sidebar) -->
<script type="text/html" data-help-name="flasher">
  <div class="red-ui-help" style="padding: 6px;">
  <h1 class="red-ui-help-title">flasher</h1>
  <div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="">
      <p>Flashes (deploys firmware to) an IoTempower node and prepares its folder structure: creates/renames node subfolders, initializes the system template, updates Wi-Fi/MQTT settings, generates <code>setup.cpp</code> from selected sensors and filters, and executes <code>iot exec deploy serial</code> via USB or RFC2217 (“Mango”).</p>
      <p>The flash command can be defined in the node configuration and/or overridden by an incoming message.</p>

      <h3><a class="red-ui-help-info-header expanded" href="#"><i class="fa fa-angle-right"></i>Inputs</a></h3>
      <dl class="message-properties">
          <dt class="optional">folder <span class="property-type">string</span></dt>
          <dd>Base folder containing the IoTempower system. Supports <code>~/</code> shorthand.</dd>

          <dt class="optional">nodeName <span class="property-type">string</span></dt>
          <dd>Name of the node’s subfolder inside <code>folder</code>. Used as the flash target.</dd>

          <dt class="optional">controllerType <span class="property-type">string</span></dt>
          <dd>Type of controller (e.g. <code>Wemos D1 Mini</code>, <code>m5stickc_plus</code>, <code>m5stickc_plus2</code>). Written to <code>node.conf</code> and determines available pins.</dd>

          <dt class="optional">deployMethod <span class="property-type">string</span></dt>
          <dd><code>usb</code> (default) or <code>mango</code> (RFC2217). Defines how <code>iot exec deploy serial</code> is called.</dd>

          <dt class="optional">port <span class="property-type">string</span></dt>
          <dd>For <code>usb</code>: path to the serial port (e.g. <code>/dev/ttyUSB0</code>). For <code>mango</code> this is ignored (uses <code>rfc2217://192.168.14.1:5000</code>).</dd>

          <dt class="optional">wifiSSID <span class="property-type">string</span></dt>
          <dd>Wi-Fi SSID. Written to <code>system.conf</code>.</dd>

          <dt class="optional">wifiPassword <span class="property-type">string</span></dt>
          <dd>Wi-Fi password. Written to <code>system.conf</code>.</dd>

          <dt class="optional">mqttHost <span class="property-type">string</span></dt>
          <dd>MQTT broker host (default <code>192.168.14.1</code>). Written to <code>system.conf</code>.</dd>

          <dt class="optional">sensor1, sensor2, sensor3 <span class="property-type">string</span></dt>
          <dd>Sensor codes from <code>devices.ini</code> (e.g. <code>dht22</code>, <code>bh1750</code>). Used to generate device calls in <code>setup.cpp</code>.</dd>

          <dt class="optional">mqttChannel1, mqttChannel2, mqttChannel3 <span class="property-type">string</span></dt>
          <dd>MQTT channels for sensors (required for most sensors).</dd>

          <dt class="optional">sensor1Pins, sensor2Pins, sensor3Pins <span class="property-type">string</span></dt>
          <dd>Comma-separated list of pins according to the sensor type and controller (e.g. <code>D5,D6</code>).</dd>

          <dt class="optional">filter1Type, filter2Type, filter3Type <span class="property-type">string</span></dt>
          <dd>Names of filters (e.g. <code>average</code>, <code>jmc_median</code>, <code>binarize</code>...) applied to the corresponding sensor.</dd>

          <dt class="optional">filter1Params, filter2Params, filter3Params <span class="property-type">object|string(JSON)</span></dt>
          <dd>Filter configuration as an object or JSON string (e.g. <code>{"buflen":100}</code>).</dd>
      </dl>

      <h3><a class="red-ui-help-info-header expanded" href="#"><i class="fa fa-angle-right"></i>Outputs</a></h3>
      <ol class="node-ports">
          <li>Flash result
              <dl class="message-properties">
                  <dt>payload <span class="property-type">object</span></dt>
                  <dd>
                      <code>{ success: boolean, output?: string, error?: string, port?: string, method?: "usb"|"mango" }</code><br/>
                      <i>success=true</i> — includes <code>output</code> (stdout) and used <code>port</code>/<code>method</code>;<br/>
                      <i>success=false</i> — includes <code>error</code> describing the issue.
                  </dd>
              </dl>
          </li>
      </ol>

      <h3><a class="red-ui-help-info-header expanded" href="#"><i class="fa fa-angle-right"></i>Details</a></h3>
      <p><b>Folder preparation:</b> if <code>system.conf</code> is missing in <code>folder</code>, the node copies templates from <code>$IOTEMPOWER_ROOT/lib/system_template</code> (<code>node_template</code> + <code>system.conf</code>) and creates a <code>nodeName</code> subfolder.</p>
      <p><b>Configuration update:</b> <code>system.conf</code> is updated with <code>IOTEMPOWER_AP_NAME</code>, <code>IOTEMPOWER_AP_PASSWORD</code>, <code>IOTEMPOWER_MQTT_HOST</code>. The <code>setup.cpp</code> file is regenerated and <code>controllerType</code> is written into <code>node.conf</code>.</p>
      <p><b>Sensors and filters:</b> each of the three slots (1..3) is described by <code>sensorX</code>/<code>mqttChannelX</code> and (if needed) <code>sensorXPins</code>. The required number of pins is validated based on the sensor type. Each measurement chain can include a filter <code>filterXType</code> with parameters <code>filterXParams</code>.</p>
      <p><b>Deployment:</b> 
         <ul>
           <li><code>usb</code> — runs <code>iot exec deploy serial --upload-port "&lt;port&gt;"</code>. If port is not provided, defaults to <code>/dev/ttyUSB0</code>. If RFC2217 URL is used in USB mode, the node warns and replaces it with a default port.</li>
           <li><code>mango</code> — uses <code>rfc2217://192.168.14.1:5000</code> (ignores the <code>port</code> field).</li>
         </ul>
      </p>
      <p><b>Node status:</b> during execution – “flashing”, on success – “done”, on failure – a red status with an error message. PID/process details are not displayed.</p>

      <h4>HTTP endpoints (for UI)</h4>
      <p>Used by the editor to manage node subfolders:</p>
      <ul>
          <li><code>GET&nbsp;/flasher/list-nodes?folder=~/iot-systems/demo</code> — list of subfolders</li>
          <li><code>POST /flasher/create-node</code> <code>{ folder, nodeName }</code></li>
          <li><code>POST /flasher/rename-node</code> <code>{ folder, from, to }</code></li>
      </ul>

      <h4>Validation and common errors</h4>
      <p>The node validates:
        <ul>
          <li>existence or creatability of <code>folder</code>;</li>
          <li>correct <code>wifiSSID</code>/<code>wifiPassword</code>/<code>mqttHost</code> during <code>system.conf</code> update;</li>
          <li>presence of sensors in <code>devices.ini</code>, non-empty <code>mqttChannelX</code>, and sufficient number of pins for each sensor.</li>
        </ul>
        On failure, it returns <code>payload.success=false</code> with <code>payload.error</code> describing the issue.
      </p>

      <h4>Examples</h4>
      <p><b>USB deploy (default port):</b></p>
      <pre><code>{
    "folder": "~/iot-systems/demo",
    "nodeName": "kitchen",
    "controllerType": "Wemos D1 Mini",
    "deployMethod": "usb",
    "sensor1": "dht22",
    "mqttChannel1": "home/kitchen/temperature",
    "sensor1Pins": "D5",
    "filter1Type": "average",
    "filter1Params": {"buflen": 50}
}</code></pre>

      <p><b>RFC2217 (“Mango”):</b></p>
      <pre><code>{
    "folder": "~/iot-systems/demo",
    "nodeName": "livingroom",
    "controllerType": "m5stickc_plus2",
    "deployMethod": "mango",
    "wifiSSID": "MyAP",
    "wifiPassword": "secret123",
    "mqttHost": "192.168.14.1"
}</code></pre>

      <h4>Tips</h4>
      <p>Wrap parameters containing spaces in quotes. Configuration fields defined in the node can be overridden via <code>msg.*</code>. Ensure unique pin usage across sensors in different slots.</p>
  </span></div></div>
</script>


<script type="text/javascript">
RED.nodes.registerType('flasher', {
  category: 'network',
  color: '#d65a31',
  icon: 'fa-microchip',
  inputs: 1,
  outputs: 1,
  defaults: {
    name:            { value: "" },
    controllerType:  { value: "Wemos D1 Mini" },

    sensor1:         { value: "" },
    sensor2:         { value: "" },
    sensor3:         { value: "" },

    mqttChannel1:    { value: "" },
    mqttChannel2:    { value: "" },
    mqttChannel3:    { value: "" },

    sensor1Pins:     { value: "" },
    sensor2Pins:     { value: "" },
    sensor3Pins:     { value: "" },

    filter1Type:     { value: "" },
    filter2Type:     { value: "" },
    filter3Type:     { value: "" },
    filter1Params:   { value: "" },
    filter2Params:   { value: "" },
    filter3Params:   { value: "" },

    folder:          { type: "flasher-folder", required: true },
    nodeName:        { value: "test01", required: true },
    
    deployMethod:    { value: "usb", required: true },
    port:            { value: "/dev/ttyUSB0", required: true }
  },
  label: function() {
    var s = [this.sensor1, this.sensor2, this.sensor3].filter(Boolean);
    var sensors = s.length ? s.join('+') : 'no-sensor';
    return this.name || `flasher ${this.controllerType} ${sensors} ${this.nodeName}`;
  },
  oneditprepare: function() {
    const state = window.flasherInitState(this);

    window.flasherPopulateBaseFields(state);

    [1,2,3].forEach(function(i){
      window.flasherUpdateSensorButton(state, i);
      window.flasherUpdatePinsButton(state, i);

      window.flasherInitFilterUI(state, i);
      $("#btn-f"+i+"-opts").on("click", function () {
        window.flasherOpenFilterDialog(state, i);
      });
    });

    $("#btn-s1").on("click", function () { window.flasherOpenSensorDialog(state, 1); });
    $("#btn-s2").on("click", function () { window.flasherOpenSensorDialog(state, 2); });
    $("#btn-s3").on("click", function () { window.flasherOpenSensorDialog(state, 3); });

    $("#btn-s1-p").on("click", function () { window.flasherOpenPinsDialog(state, 1); });
    $("#btn-s2-p").on("click", function () { window.flasherOpenPinsDialog(state, 2); });
    $("#btn-s3-p").on("click", function () { window.flasherOpenPinsDialog(state, 3); });

    window.flasherBindControllerChange(state);
    window.flasherSetupTabs(state);
    window.flasherBindLabelSync(state);
    window.flasherUpdateNodeLabel(state);

    ["1","2","3"].forEach(function(i){
      const key = "filter"+i+"Params";
      const v = (state.node && state.node[key]) || "{}";
      $("#node-input-"+key).val(v);
    });
    if (window.flasherSetupNodeSelectorMain) {
      window.flasherSetupNodeSelectorMain();
    }
  },
  oneditsave: function() {
    try {
      [1,2,3].forEach((i)=>{
        const key = "filter"+i+"Params";
        const val = this[key] || "{}";
        $("#node-input-"+key).val(typeof val === "string" ? val : JSON.stringify(val));
      });
    } catch(e) {}
  }
});
</script>
