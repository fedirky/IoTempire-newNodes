<!-- flasher.html -->

<!-- External resources (added via package.json -> node-red.resources) -->
<link rel="stylesheet" href="resources/node-red-contrib-flasher/editor/flasher.css">
<script src="resources/node-red-contrib-flasher/editor/flasher.utils.js"></script>
<script src="resources/node-red-contrib-flasher/editor/flasher.pins.js"></script>
<script src="resources/node-red-contrib-flasher/editor/flasher.sensors.js"></script>

<!-- Config node template for folder settings -->
<script type="text/html" data-template-name="flasher-folder">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Optional">
  </div>
  <div class="form-row">
    <label for="node-config-input-path"><i class="fa fa-folder-open"></i> Folder</label>
    <input type="text" id="node-config-input-path" placeholder="~/iot-systems/demo">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiSSID"><i class="fa fa-wifi"></i> WiFi SSID</label>
    <input type="text" id="node-config-input-wifiSSID" placeholder="Your WiFi SSID">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiPassword"><i class="fa fa-lock"></i> WiFi Password</label>
    <input type="password" id="node-config-input-wifiPassword" placeholder="Your WiFi Password">
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType("flasher-folder", {
  category: "config",
  defaults: {
    name:     { value: "" },
    path:     { value: "~/iot-systems/demo", required: false },
    wifiSSID: { value: "", required: false }
  },
  credentials: {
    wifiPassword: { type: "password" }
  },
  label: function () {
    return this.name || this.path || "folder";
  }
});
</script>

<!-- Main node template -->
<script type="text/html" data-template-name="flasher">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Label (optional)">
  </div>

  <div class="form-row">
    <div class="red-ui-tabs">
      <div>
        <ul id="node-config-flasher-tabs" style="margin-bottom:10px;">
          <li class="red-ui-tab active" id="red-ui-tab-flasher-folder" style="width:50%;">
            <a href="#flasher-tab-folder" class="red-ui-tab-label">Flashing Info</a>
          </li>
          <li class="red-ui-tab" id="red-ui-tab-flasher-sensor" style="width:50%;">
            <a href="#flasher-tab-sensor" class="red-ui-tab-label">Controller & Sensors</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div id="node-config-flasher-tabs-content" style="min-height:100px;">
    <!-- Flashing tab -->
    <div id="flasher-tab-folder" style="display:block;">
      <div class="form-row">
        <label for="node-input-folder"><i class="fa fa-folder-open"></i> Folder Config</label>
        <input type="text" id="node-input-folder">
      </div>
      <div class="form-row">
        <label for="node-input-nodeName"><i class="fa fa-cube"></i> Node</label>
        <input type="text" id="node-input-nodeName" placeholder="test01">
      </div>
      <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Serial Port</label>
        <input type="text" id="node-input-port" placeholder="/dev/ttyUSB0">
      </div>
    </div>

    <!-- Controller & Sensors tab -->
    <div id="flasher-tab-sensor" style="display:none;">
      <div class="form-row">
        <label for="node-input-controllerType"><i class="fa fa-microchip"></i> Controller Type</label>
        <select id="node-input-controllerType">
          <option value="Wemos D1 Mini">Wemos D1 Mini</option>
          <option value="m5stickc">M5StickC</option>
          <!-- Add more controllers here if needed -->
        </select>
      </div>

      <!-- Sensor 1 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 1</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s1"    class="red-ui-button" style="flex:1;">Sensor 1 Settings…</button>
          <button id="btn-s1-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>

      <!-- Sensor 2 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 2</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s2"    class="red-ui-button" style="flex:1;">Sensor 2 Settings…</button>
          <button id="btn-s2-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>

      <!-- Sensor 3 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 3</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s3"    class="red-ui-button" style="flex:1;">Sensor 3 Settings…</button>
          <button id="btn-s3-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>

      <!-- Hidden fields actually saved by Node-RED -->
      <input type="text" id="node-input-sensor1" style="display:none">
      <input type="text" id="node-input-sensor2" style="display:none">
      <input type="text" id="node-input-sensor3" style="display:none">
      <input type="text" id="node-input-mqttChannel1" style="display:none">
      <input type="text" id="node-input-mqttChannel2" style="display:none">
      <input type="text" id="node-input-mqttChannel3" style="display:none">
      <!-- Pins stored as comma-separated strings, e.g. "D5,D6" -->
      <input type="text" id="node-input-sensor1Pins" style="display:none">
      <input type="text" id="node-input-sensor2Pins" style="display:none">
      <input type="text" id="node-input-sensor3Pins" style="display:none">
    </div>
  </div>

  <!-- Reusable dialog for Sensor Settings -->
  <div id="flasher-sensor-dialog" style="display:none;">
    <div class="form-row">
      <label for="dlg-sensor-type"><i class="fa fa-thermometer-half"></i> Sensor</label>
      <select id="dlg-sensor-type">
        <option value="">— None —</option>
        <option value="dht">Temperature/Humidity (DHT)</option>
        <option value="mfrc522">Tag Reader (MFRC522)</option>
        <option value="hcsr04">Ultrasonic Distance (HCSR04)</option>
      </select>
    </div>
    <div class="form-row">
      <label for="dlg-sensor-topic"><i class="fa fa-share-alt"></i> MQTT Channel</label>
      <input type="text" id="dlg-sensor-topic" placeholder="topic/name">
    </div>
  </div>

  <!-- Reusable dialog for Pins Settings (content is built dynamically) -->
  <div id="flasher-pins-dialog" style="display:none;">
    <!-- Dynamic rows inserted here via JS depending on sensor + controller -->
    <div id="pins-dynamic"></div>
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType('flasher', {
  category: 'network',
  color: '#d65a31',
  icon: 'fa-microchip',
  inputs: 1,
  outputs: 1,
  defaults: {
    name:            { value: "" },
    controllerType:  { value: "Wemos D1 Mini" },

    // Three sensors stored separately
    sensor1:         { value: "" },
    sensor2:         { value: "" },
    sensor3:         { value: "" },

    // Separate MQTT channels
    mqttChannel1:    { value: "" },
    mqttChannel2:    { value: "" },
    mqttChannel3:    { value: "" },

    // Pins per sensor (comma-separated)
    sensor1Pins:     { value: "" },
    sensor2Pins:     { value: "" },
    sensor3Pins:     { value: "" },

    folder:          { type: "flasher-folder", required: true },
    nodeName:        { value: "test01" },
    port:            { value: "/dev/ttyUSB0" }
  },
  label: function() {
    var s = [this.sensor1, this.sensor2, this.sensor3].filter(Boolean);
    var sensors = s.length ? s.join('+') : 'no-sensor';
    return this.name || `flasher ${this.controllerType} ${sensors} ${this.nodeName}`;
  },
  oneditprepare: function() {
    // Glue only: delegate to extracted helpers
    const state = window.flasherInitState(this);

    window.flasherPopulateBaseFields(state);

    // Initial button labels
    [1,2,3].forEach(function(i){
      window.flasherUpdateSensorButton(state, i);
      window.flasherUpdatePinsButton(state, i);
    });

    // Bind open buttons (sensor settings)
    $("#btn-s1").on("click", function () { window.flasherOpenSensorDialog(state, 1); });
    $("#btn-s2").on("click", function () { window.flasherOpenSensorDialog(state, 2); });
    $("#btn-s3").on("click", function () { window.flasherOpenSensorDialog(state, 3); });

    // Bind open buttons (pins settings)
    $("#btn-s1-p").on("click", function () { window.flasherOpenPinsDialog(state, 1); });
    $("#btn-s2-p").on("click", function () { window.flasherOpenPinsDialog(state, 2); });
    $("#btn-s3-p").on("click", function () { window.flasherOpenPinsDialog(state, 3); });

    window.flasherBindControllerChange(state);
    window.flasherSetupTabs(state);
    window.flasherBindLabelSync(state);
    window.flasherUpdateNodeLabel(state);
  }
});
</script>
