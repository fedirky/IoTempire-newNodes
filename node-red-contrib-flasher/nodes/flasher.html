<!-- flasher.html -->

<style>
/* Make dialog fields look like the main editor fields */

/* --- shared form row style used by both dialogs --- */
#flasher-sensor-dialog .form-row,
#flasher-pins-dialog .form-row {
  display: flex;               /* align label + field like the main form */
  align-items: center;
  gap: 8px;                    /* space between label and field */
  margin-bottom: 8px;          /* vertical space between rows */
}

/* Label width similar to the main editor */
#flasher-sensor-dialog .form-row > label,
#flasher-pins-dialog .form-row > label {
  width: 160px;                /* tweak if your editor uses a different width */
  display: inline-block;
  margin: 0;                   /* remove extra spacing */
  white-space: nowrap;
  color: #444;
}

/* Inputs/selects look & sizing */
#flasher-sensor-dialog .form-row > input[type="text"],
#flasher-sensor-dialog .form-row > select,
#flasher-pins-dialog   .form-row > input[type="text"],
#flasher-pins-dialog   .form-row > select {
  flex: 1;                     
  height: 28px;                
  line-height: 1.4;
  padding: 2px 6px;
  box-sizing: border-box;
  border: 1px solid var(--red-ui-secondary-border, #c8c8c8);
  border-radius: 4px;
  background: #fff;
  font-size: 13px;
  color: #444;
}

/* Focus state similar to editor (no harsh black outline) */
#flasher-sensor-dialog .form-row > input[type="text"]:focus,
#flasher-sensor-dialog .form-row > select:focus,
#flasher-pins-dialog   .form-row > input[type="text"]:focus,
#flasher-pins-dialog   .form-row > select:focus {
  outline: none;
  border-color: #9ecaed;
  box-shadow: 0 0 0 2px rgba(158,202,237,.2);
}

/* Dialog paddings */
.ui-dialog .ui-dialog-content#flasher-sensor-dialog,
.ui-dialog .ui-dialog-content#flasher-pins-dialog {
  padding-top: 10px;
  background: #fff;
}

/* Button bar spacing consistent with editor */
.ui-dialog .ui-dialog-buttonpane {
  padding: 0.4em 0.6em 0.6em;
}

/* Optional: make sensor & pins buttons look like inputs */
#flasher-tab-sensor .red-ui-button {
  height: 28px;
  line-height: 24px;
  padding: 2px 8px;
  width: 100%;
  text-align: left;
  color: #444;
  background: #fff;
  border: 1px solid var(--red-ui-secondary-border, #c8c8c8);
  box-shadow: none;
  opacity: 1;
}
#flasher-tab-sensor .red-ui-button:hover,
#flasher-tab-sensor .red-ui-button:focus {
  border-color: #9ecaed;
  box-shadow: 0 0 0 2px rgba(158,202,237,.2);
  outline: none;
}
</style>

<!-- Config node template for folder settings -->
<script type="text/html" data-template-name="flasher-folder">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Optional">
  </div>
  <div class="form-row">
    <label for="node-config-input-path"><i class="fa fa-folder-open"></i> Folder</label>
    <input type="text" id="node-config-input-path" placeholder="~/iot-systems/demo">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiSSID"><i class="fa fa-wifi"></i> WiFi SSID</label>
    <input type="text" id="node-config-input-wifiSSID" placeholder="Your WiFi SSID">
  </div>
  <div class="form-row">
    <label for="node-config-input-wifiPassword"><i class="fa fa-lock"></i> WiFi Password</label>
    <input type="password" id="node-config-input-wifiPassword" placeholder="Your WiFi Password">
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType("flasher-folder", {
  category: "config",
  defaults: {
    name:     { value: "" },
    path:     { value: "~/iot-systems/demo", required: false },
    wifiSSID: { value: "", required: false }
  },
  credentials: {
    wifiPassword: { type: "password" }
  },
  label: function () {
    return this.name || this.path || "folder";
  }
});
</script>

<!-- Main node template -->
<script type="text/html" data-template-name="flasher">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Label (optional)">
  </div>

  <div class="form-row">
    <div class="red-ui-tabs">
      <div>
        <ul id="node-config-flasher-tabs" style="margin-bottom:10px;">
          <li class="red-ui-tab active" id="red-ui-tab-flasher-folder" style="width:50%;">
            <a href="#flasher-tab-folder" class="red-ui-tab-label">Flashing Info</a>
          </li>
          <li class="red-ui-tab" id="red-ui-tab-flasher-sensor" style="width:50%;">
            <a href="#flasher-tab-sensor" class="red-ui-tab-label">Controller & Sensors</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div id="node-config-flasher-tabs-content" style="min-height:100px;">
    <!-- Flashing tab -->
    <div id="flasher-tab-folder" style="display:block;">
      <div class="form-row">
        <label for="node-input-folder"><i class="fa fa-folder-open"></i> Folder Config</label>
        <input type="text" id="node-input-folder">
      </div>
      <div class="form-row">
        <label for="node-input-nodeName"><i class="fa fa-cube"></i> Node</label>
        <input type="text" id="node-input-nodeName" placeholder="test01">
      </div>
      <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Serial Port</label>
        <input type="text" id="node-input-port" placeholder="/dev/ttyUSB0">
      </div>
    </div>

    <!-- Controller & Sensors tab -->
    <div id="flasher-tab-sensor" style="display:none;">
      <div class="form-row">
        <label for="node-input-controllerType"><i class="fa fa-microchip"></i> Controller Type</label>
        <select id="node-input-controllerType">
          <option value="Wemos D1 Mini">Wemos D1 Mini</option>
          <option value="m5stickc">M5StickC</option>
          <!-- Add more controllers here if needed -->
        </select>
      </div>

      <!-- Sensor 1 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 1</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s1"    class="red-ui-button" style="flex:1;">Sensor 1 Settings…</button>
          <button id="btn-s1-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>

      <!-- Sensor 2 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 2</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s2"    class="red-ui-button" style="flex:1;">Sensor 2 Settings…</button>
          <button id="btn-s2-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>

      <!-- Sensor 3 -->
      <div class="form-row">
        <label><i class="fa fa-sliders"></i> Sensor 3</label>
        <div style="display:flex; gap:8px; width:100%;">
          <button id="btn-s3"    class="red-ui-button" style="flex:1;">Sensor 3 Settings…</button>
          <button id="btn-s3-p"  class="red-ui-button" style="width:180px;">Pins…</button>
        </div>
      </div>

      <!-- Hidden fields actually saved by Node-RED -->
      <input type="text" id="node-input-sensor1" style="display:none">
      <input type="text" id="node-input-sensor2" style="display:none">
      <input type="text" id="node-input-sensor3" style="display:none">
      <input type="text" id="node-input-mqttChannel1" style="display:none">
      <input type="text" id="node-input-mqttChannel2" style="display:none">
      <input type="text" id="node-input-mqttChannel3" style="display:none">
      <!-- Pins stored as comma-separated strings, e.g. "D5,D6" -->
      <input type="text" id="node-input-sensor1Pins" style="display:none">
      <input type="text" id="node-input-sensor2Pins" style="display:none">
      <input type="text" id="node-input-sensor3Pins" style="display:none">
    </div>
  </div>

  <!-- Reusable dialog for Sensor Settings -->
  <div id="flasher-sensor-dialog" style="display:none;">
    <div class="form-row">
      <label for="dlg-sensor-type"><i class="fa fa-thermometer-half"></i> Sensor</label>
      <select id="dlg-sensor-type">
        <option value="">— None —</option>
        <option value="dht">Temperature/Humidity (DHT)</option>
        <option value="mfrc522">Tag Reader (MFRC522)</option>
        <option value="hcsr04">Ultrasonic Distance (HCSR04)</option>
      </select>
    </div>
    <div class="form-row">
      <label for="dlg-sensor-topic"><i class="fa fa-share-alt"></i> MQTT Channel</label>
      <input type="text" id="dlg-sensor-topic" placeholder="topic/name">
    </div>
  </div>

  <!-- Reusable dialog for Pins Settings (content is built dynamically) -->
  <div id="flasher-pins-dialog" style="display:none;">
    <!-- Dynamic rows inserted here via JS depending on sensor + controller -->
    <div id="pins-dynamic"></div>
  </div>
</script>

<script type="text/javascript">
RED.nodes.registerType('flasher', {
  category: 'network',
  color: '#d65a31',
  icon: 'fa-microchip',
  inputs: 1,
  outputs: 1,
  defaults: {
    name:            { value: "" },
    controllerType:  { value: "Wemos D1 Mini" },

    // Three sensors stored separately
    sensor1:         { value: "" },
    sensor2:         { value: "" },
    sensor3:         { value: "" },

    // Separate MQTT channels
    mqttChannel1:    { value: "" },
    mqttChannel2:    { value: "" },
    mqttChannel3:    { value: "" },

    // Pins per sensor (comma-separated)
    sensor1Pins:     { value: "" },
    sensor2Pins:     { value: "" },
    sensor3Pins:     { value: "" },

    folder:          { type: "flasher-folder", required: true },
    nodeName:        { value: "test01" },
    port:            { value: "/dev/ttyUSB0" }
  },
  label: function() {
    var s = [this.sensor1, this.sensor2, this.sensor3].filter(Boolean);
    var sensors = s.length ? s.join('+') : 'no-sensor';
    return this.name || `flasher ${this.controllerType} ${sensors} ${this.nodeName}`;
  },
  oneditprepare: function() {
    var currentIdx = null;

    /* ---- Controller pins map (adjust to your boards) ---- */
    // NOTE: Customize these arrays to reflect your actual controller pinouts.
    var CONTROLLER_PINS = {
      "Wemos D1 Mini": ["D0","D1","D2","D3","D4","D5","D6","D7","D8","A0"],
      "m5stickc":      ["G0","G26","G32","G33","G34","G36"]  // example subset
    };

    /* ---- Sensor pin requirements ---- */
    // Labels here become field labels in the pins dialog
    var SENSOR_PIN_SPEC = {
      "":        [],
      "dht":     ["Pin1"],
      "hcsr04":  ["Pin1","Pin2"],
      "mfrc522": []   // requires hardware pins; no manual selection
    };

    // Update text of the sensor settings button
    function updateSensorButton(idx) {
      var s = $("#node-input-sensor" + idx).val() || "";
      var t = $("#node-input-mqttChannel" + idx).val() || "";
      var label = "Sensor " + idx + " Settings…";
      if (s) label = s + (t ? " → " + t : "");
      $("#btn-s" + idx).text(label);
    }

    // Update text of the pins button
    function updatePinsButton(idx) {
      var s = $("#node-input-sensor" + idx).val() || "";
      var pinsStr = $("#node-input-sensor" + idx + "Pins").val() || "";
      var spec = SENSOR_PIN_SPEC[s] || [];
      var label = "Pins…";
      if (!s || spec.length === 0) {
        label = "Pins… (n/a)";
      } else if (pinsStr) {
        label = "Pins: " + pinsStr;
      }
      $("#btn-s" + idx + "-p").text(label);
      $("#btn-s" + idx + "-p").prop("disabled", (!s || spec.length === 0));
    }

    // Build pins dialog content based on sensor + controller
    function buildPinsDialog(idx){
      var controller = $("#node-input-controllerType").val();
      var options = CONTROLLER_PINS[controller] || [];
      var sensorCode = $("#node-input-sensor"+idx).val() || "";
      var spec = SENSOR_PIN_SPEC[sensorCode] || [];
      var existing = ($("#node-input-sensor"+idx+"Pins").val() || "").split(",").map(s=>s.trim()).filter(Boolean);

      // Collect pins already used by other sensors
      var usedPins = [];
      [1,2,3].forEach(function(i){
        if (i !== idx) {
          var pins = ($("#node-input-sensor"+i+"Pins").val() || "")
            .split(",").map(s=>s.trim()).filter(Boolean);
          usedPins = usedPins.concat(pins);
        }
      });

      var $wrap = $("#pins-dynamic");
      $wrap.empty();

      if (spec.length === 0) {
        $wrap.append(
          '<div class="form-row"><label></label><div style="color:#666;">This sensor does not require manual pin selection on this controller.</div></div>'
        );
        return;
      }

      // Create selects
      spec.forEach(function(role, i){
        var selId = "dlg-pin-"+i;
        var html = '<div class="form-row">' +
                    '<label>'+ role +'</label>' +
                    '<select id="'+ selId +'"></select>' +
                  '</div>';
        $wrap.append(html);

        var $sel = $("#"+selId);
        $sel.append('<option value="">— Select —</option>');

        options.forEach(function(p){
          var isUsedByOthers = usedPins.includes(p);
          var opt = $('<option></option>').val(p).text(p);
          if (isUsedByOthers) opt.prop('disabled', true); // block pins already taken by other sensors
          $sel.append(opt);
        });

        if (existing[i]) { $sel.val(existing[i]); }
      });

      // Enforce uniqueness across selects *inside this dialog*
      function refreshInDialogDisables(){
        var selected = {};
        // collect current selections
        spec.forEach(function(_, i){
          var v = $("#dlg-pin-"+i).val();
          if (v) selected[v] = (selected[v] || 0) + 1;
        });
        // disable duplicates in other selects + keep own selected enabled
        spec.forEach(function(_, i){
          var $sel = $("#dlg-pin-"+i);
          $sel.find('option').each(function(){
            var val = $(this).val();
            if (!val) return;
            var takenByOthers = (selected[val] && $sel.val() !== val); // chosen in another select of this dialog
            // already-disabled by other sensors stays disabled
            var disabledByOthers = $(this).prop('disabled') && !takenByOthers;
            $(this).prop('disabled', disabledByOthers || takenByOthers);
          });
        });
      }

      // Bind change handlers and run once
      spec.forEach(function(_, i){
        $("#dlg-pin-"+i).on('change', refreshInDialogDisables);
      });
      refreshInDialogDisables();
    }

    // Open pins dialog for a sensor
    function openPinsDialog(idx){
      buildPinsDialog(idx);
      $("#flasher-pins-dialog").dialog({
        modal: true,
        width: 520,
        title: "Sensor " + idx + " Pins",
        buttons: [
          {
            text: "Save",
            click: function () {
              var controller = $("#node-input-controllerType").val();
              var options = CONTROLLER_PINS[controller] || [];
              var sensorCode = $("#node-input-sensor"+idx).val() || "";
              var spec = SENSOR_PIN_SPEC[sensorCode] || [];
              // Collect selected pins in order
              var pins = [];
              var valid = true;
              for (var i=0;i<spec.length;i++){
                var v = $("#dlg-pin-"+i).val();
                if (!v) { valid = false; break; }
                pins.push(v);
              }
              if (!valid) {
                // Simple inline validation
                $("#pins-dynamic").append('<div class="form-row"><label></label><div style="color:#b00;">Please select all required pins.</div></div>');
                return;
              }
              // Save as comma-separated string
              $("#node-input-sensor"+idx+"Pins").val(pins.join(", ")).change();
              updatePinsButton(idx);
              $(this).dialog("close");
            }
          },
          {
            text: "Cancel",
            click: function(){ $(this).dialog("close"); }
          }
        ]
      });
    }

    // Populate base fields
    $("#node-input-name").val(this.name);
    $("#node-input-nodeName").val(this.nodeName);
    $("#node-input-port").val(this.port);
    $("#node-input-controllerType").val(this.controllerType);

    // Populate hidden sensor/channel/pins fields
    $("#node-input-sensor1").val(this.sensor1 || "");
    $("#node-input-mqttChannel1").val(this.mqttChannel1 || "");
    $("#node-input-sensor1Pins").val(this.sensor1Pins || "");

    $("#node-input-sensor2").val(this.sensor2 || "");
    $("#node-input-mqttChannel2").val(this.mqttChannel2 || "");
    $("#node-input-sensor2Pins").val(this.sensor2Pins || "");

    $("#node-input-sensor3").val(this.sensor3 || "");
    $("#node-input-mqttChannel3").val(this.mqttChannel3 || "");
    $("#node-input-sensor3Pins").val(this.sensor3Pins || "");

    // Sensor settings dialog
    function openSensorDialog(idx) {
      $("#dlg-sensor-type").val($("#node-input-sensor" + idx).val() || "");
      $("#dlg-sensor-topic").val($("#node-input-mqttChannel" + idx).val() || "");

      $("#flasher-sensor-dialog").dialog({
        modal: true,
        width: 520,
        title: "Sensor " + idx + " Settings",
        buttons: [
          {
            text: "Save",
            click: function () {
              $("#node-input-sensor" + idx).val($("#dlg-sensor-type").val()).change();
              $("#node-input-mqttChannel" + idx).val($("#dlg-sensor-topic").val()).change();
              updateSensorButton(idx);
              updatePinsButton(idx);   // pins requirements may change with sensor type
              updateNodeLabel();
              $(this).dialog("close");
            }
          },
          {
            text: "Cancel",
            click: function () { $(this).dialog("close"); }
          }
        ]
      });
    }

    // Bind open buttons (sensor settings)
    $("#btn-s1").on("click", function () { openSensorDialog(1); });
    $("#btn-s2").on("click", function () { openSensorDialog(2); });
    $("#btn-s3").on("click", function () { openSensorDialog(3); });

    // Bind open buttons (pins settings)
    $("#btn-s1-p").on("click", function () { openPinsDialog(1); });
    $("#btn-s2-p").on("click", function () { openPinsDialog(2); });
    $("#btn-s3-p").on("click", function () { openPinsDialog(3); });

    // Initial button labels
    [1,2,3].forEach(function(i){ updateSensorButton(i); updatePinsButton(i); });

    // When controller changes, pins list changes → rebuild pins selections next time
    $("#node-input-controllerType").on("change", function(){
      // Clear pins if previously selected (optional; comment out if you want to keep)
      // [1,2,3].forEach(function(i){ $("#node-input-sensor"+i+"Pins").val(""); });
      [1,2,3].forEach(updatePinsButton);
    });

    // Tabs switching
    $("#node-config-flasher-tabs li").on('click', function() {
      var id = $(this).attr('id');
      $("#node-config-flasher-tabs li").removeClass('active');
      $(this).addClass('active');
      $("#node-config-flasher-tabs-content > div").hide();
      if (id === 'red-ui-tab-flasher-folder') {
        $('#flasher-tab-folder').show();
      } else {
        $('#flasher-tab-sensor').show();
      }
    });

    // Update node label preview
    function updateNodeLabel() {
      var n = {
        name: $("#node-input-name").val(),
        nodeName: $("#node-input-nodeName").val(),
        controllerType: $("#node-input-controllerType").val()
      };
      var s = [
        $("#node-input-sensor1").val(),
        $("#node-input-sensor2").val(),
        $("#node-input-sensor3").val()
      ].filter(Boolean);
      $(".node-input-label").text(
        RED._(n.name || `flasher ${n.controllerType} ${s.length ? s.join('+') : 'no-sensor'} ${n.nodeName}`)
      );
    }

    // Keep label in sync with field changes
    [
      "#node-input-name",
      "#node-input-nodeName",
      "#node-input-controllerType",
      "#node-input-port",
      "#node-input-folder",

      "#node-input-sensor1",
      "#node-input-mqttChannel1",
      "#node-input-sensor1Pins",

      "#node-input-sensor2",
      "#node-input-mqttChannel2",
      "#node-input-sensor2Pins",

      "#node-input-sensor3",
      "#node-input-mqttChannel3",
      "#node-input-sensor3Pins"
    ].forEach(function(sel){
      $(sel).on('change keyup', updateNodeLabel);
    });

    updateNodeLabel();
  }
});
</script>
